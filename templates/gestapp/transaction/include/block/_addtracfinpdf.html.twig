{{ form_start(form) }}
{% if transaction.actePdfFilename is null and transaction.tracfinPdfFilename is null and transaction.dateAtSale is not null %}
    {# Il n'y a pas de promesse de vente et pas de date de signature enregistrée en BDD #}
    <td>
        <span id="rowEmptyTracfinPdf">-</span>
        <div class="input-group w-100">
            {{ form_widget(form.tracfinPdfFilename, {'attr': {'class':'form-control form-control-sm d-none'}}) }}
            <button class="btn btn-sm btn-secondary d-none" type="button" id="btnAddTracfinPdf"><i class="fa-light fa-check"></i></button>
        </div>
    </td>
    <td>
        {{ form_widget(form.isSupprTracfinPdf, {'attr': {'class':'form-control form-control-sm d-none'}}) }}
    </td>
{% elseif transaction.actePdfFilename is not null and transaction.tracfinPdfFilename is null and transaction.dateAtSale is not null %}
    {# Il n'y a pas de tracfin mais une date de signature d'acte est enregistrée en BDD #}
    <td>
        <div class="input-group w-100">
            {{ form_widget(form.tracfinPdfFilename, {'attr': {'class':'form-control form-control-sm'}}) }}
            {% if 'ROLE_SUPER_ADMIN' in app.user.roles %}
                {# Dans ce cas, on valide le document par un référent #}
                <button class="btn btn-sm btn-secondary" type="button" id="btnAddTracfinPdf"><i class="fa-light fa-check"></i></button>
            {% endif %}
            {% if 'ROLE_EMPLOYED' in app.user.roles %}
                {# Dans ce cas, on valide le document par un référent #}
                <button class="btn btn-sm btn-secondary" type="button" id="btnAddTracfinPdfbyColl"><i class="fa-light fa-check"></i></button>
            {% endif %}
        </div>
    </td>
    <td>
        <div class="form-check d-none">
            {{ form_widget(form.isSupprTracfinPdf, {'attr': {'class':'form-check-input'}}) }}
            <label class="form-check-label" for="flexCheckDefault">
                Supprimer
            </label>
        </div>
    </td>
{% elseif transaction.actePdfFilename is not null and transaction.tracfinPdfFilename is not null and transaction.dateAtSale is not null %}
    {# Dans ce cas, le fichier est présent et une date de promesse est présente en BDD #}
    {% if 'ROLE_SUPER_ADMIN' in app.user.roles %}
        <td>
            {% if transaction.refEmployed is not same as app.user.id and transaction.isValidtracfinPdf == 0 %}
                {# Présent si le document est présente par un collaborateur #}
                <p class="alert alert-warning mb-0 p-1">Document à contrôler {{ form_widget(form.tracfinPdfFilename, {'attr': {'class':'form-control form-control-sm d-none' }}) }}</p>
            {% else %}
                <div class="input-group w-100">
                    {{ form_widget(form.tracfinPdfFilename, {'attr': {'class':'form-control form-control-sm' }}) }}
                    <button class="btn btn-sm btn-info" type="button" id="btnEditTracfinPdf"><i class="fa-light fa-arrows-rotate"></i></button>
                </div>
            {% endif %}
        </td>
        <td>
            {% set refyear = transaction.property.ref|split('/',2)|first %}
            {% set refnumber = transaction.property.ref|split('/',2)|last %}
            <button id="showTracfin" type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#modalTracfin"><i class="fa-duotone fa-eye"></i> Voir le document</button>
            <a class="btn btn-sm btn-secondary" href="{{ asset('properties/'~ refyear ~'-'~ refnumber ~'/documents/' ~ transaction.tracfinPdfFilename) }}" download="{{ transaction.tracfinPdfFilename }}"><i class="fa-duotone fa-download"></i></a>

            <!-- Modal -->
            <div class="modal fade" id="modalTracfin" tabindex="-1" aria-labelledby="modalTracfin" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Tracfin</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" style="padding: 0;">
                            <div id="externaFile">
                                <iframe src="{{ asset('properties/'~ refyear ~'-'~ refnumber ~'/documents/' ~ transaction.tracfinPdfFilename) }}" width="100%" height="500px"></iframe>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
        </td>
        {% if transaction.refEmployed is not same as app.user.id and transaction.isValidtracfinPdf == 0 %}
            <td>
                <a href="{{ path('op_gestapp_transaction_validtracfinpdf', {'id': transaction.id}) }}" class="btn btn-sm btn-success" id="btnAddTracfinPdfControl"><i class="fa-light fa-check"></i> Je valide</a>
                <a href="{{ path('op_gestapp_transaction_errordocument', {'id': transaction.id, 'name':transaction.tracfinPdfFilename}) }}" class="btn btn-sm btn-danger" id="btnDocumentPdfError"><i class="fa-sharp fa-regular fa-xmark"></i> Erreur de document</a>
            </td>
        {% endif %}
        <td>
            <a class="btn btn-sm btn-secondary supprDocument" href="{{ path('op_gestapp_transaction_deldocument', {'id': transaction.id, 'name':transaction.tracfinPdfFilename}) }}" ><i class="fa-duotone fa-trash"></i></a>
            <div class="form-check d-none ">
                {{ form_widget(form.isSupprTracfinPdf, {'attr': {'class':'form-check-input'}}) }}
                <label class="form-check-label" for="flexCheckDefault21">
                    Supprimer
                </label>
            </div>
        </td>
    {% endif %}
    {% if 'ROLE_EMPLOYED' in app.user.roles and transaction.isValidTracfinpdf == 0 %}
        {# Dans le cas où le fichier a été déposé par le collaborateur mais non validé par le référent #}
        <td>
            <p class="alert alert-warning mb-0 p-1"><i class="fa-duotone fa-hourglass-start"></i> Les 2 documents sont déposés et doivent être controlé.</p>
        </td>
        <td class="d-none">
            {{ form_widget(form.tracfinPdfFilename, {'attr': {'class':'form-control form-control-sm' }}) }}
            {{ form_widget(form.isSupprTracfinPdf, {'attr': {'class':'form-control form-control-sm d-none'}}) }}
        </td>
    {% endif %}
    {% if 'ROLE_EMPLOYED' in app.user.roles and transaction.isValidTracfinpdf == 1 %}
        {# Le ficheir déposé a été vérifié, il peut être modifier si besoin. #}
        <td>
            <div class="input-group w-100">
                {{ form_widget(form.tracfinPdfFilename, {'attr': {'class':'form-control form-control-sm' }}) }}
                <button class="btn btn-sm btn-info" type="button" id="btnEditTracfinPdf"><i class="fa-light fa-arrows-rotate"></i></button>
            </div>
        </td>
        <td>
            {% set refyear = transaction.property.ref|split('/',2)|first %}
            {% set refnumber = transaction.property.ref|split('/',2)|last %}
            <button id="showTracfin" type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#modalTracfin"><i class="fa-duotone fa-eye"></i> Voir le document</button>
            <a class="btn btn-sm btn-secondary" href="{{ asset('properties/'~ refyear ~'-'~ refnumber ~'/documents/' ~ transaction.tracfinPdfFilename) }}" download="{{ transaction.tracfinPdfFilename }}"><i class="fa-duotone fa-download"></i></a>
            <!-- Modal -->
            <div class="modal fade" id="modalTracfin" tabindex="-1" aria-labelledby="modalTracfin" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Tracfin</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" style="padding: 0;">
                            <div id="externaFile">
                                <iframe src="{{ asset('properties/'~ refyear ~'-'~ refnumber ~'/documents/' ~ transaction.tracfinPdfFilename) }}" width="100%" height="500px"></iframe>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
        </td>
        <td>
            <p class="m-0 text-end">Document validé et conforme.</p>
            <div class="d-none">
                {{ form_widget(form.isSupprTracfinPdf, {'attr': {'class':''}}) }} {{ form_label(form.isSupprTracfinPdf) }}
            </div>

        </td>
    {% endif %}
{% endif %}
{{ form_end(form) }}